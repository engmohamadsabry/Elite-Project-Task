<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Statement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-4">

    <div class="container">
        <h2 class="mb-4">Account Statement</h2>

        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Select Account</label>
                <select id="accountSelect" class="form-select"></select>
            </div>
            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" id="fromDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" id="toDate" class="form-control">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button id="searchBtn" class="btn btn-primary w-100">Search</button>
            </div>
        </div>

        <!-- Actions -->
        <div class="mb-3">
            <button id="printBtn" class="btn btn-secondary me-2">Print</button>
            <button id="exportBtn" class="btn btn-success">Export to Excel</button>
        </div>

        <!-- Table -->
        <table class="table table-bordered" id="accountTable">
            <thead class="table-light">
                <tr>
                    <th>Account ID</th>
                    <th>Account Name</th>
                    <th>Previous Balance</th>
                    <th>Debit Amount</th>
                    <th>Credit Amount</th>
                    <th>Final Balance</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot class="table-light">
                <tr>
                    <th colspan="3" class="text-end">Totals:</th>
                    <th id="totalDebit">0</th>
                    <th id="totalCredit">0</th>
                    <th id="totalFinal">0</th>
                    <th></th>
                </tr>
            </tfoot>
        </table>

        <!-- Summary Section -->
        <div class="mt-3">
            <h5>Account Summary</h5>
            <p><strong>First Previous Balance:</strong> <span id="firstPrevBalance">0</span></p>
            <p><strong>Total Debits:</strong> <span id="sumDebit">0</span></p>
            <p><strong>Total Credits:</strong> <span id="sumCredit">0</span></p>
            <p><strong>Final Balance:</strong> <span id="sumFinal">0</span></p>
        </div>


        <!-- Pagination -->
        <nav>
            <ul id="pagination" class="pagination"></ul>
        </nav>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transaction Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionDetails"></div>
            </div>
        </div>
    </div>

    <script>
        let tableData = [];
        let currentPage = 1;
        let pageSize = 10; // default

        $(document).ready(function () {
            // Load accounts into dropdown
            $.getJSON("/api/Account", function (accounts) {
                $("#accountSelect").append(`<option value="">-- Select Account --</option>`);
                $.each(accounts, function (i, acc) {
                    $("#accountSelect").append(`<option value="${acc.accountId}">${acc.accountId+' '+ acc.accountName}</option>`);
                });
            });

            // Search button
            $("#searchBtn").click(function () {
                currentPage = 1;
                loadPage();
            });

            // Load data with pagination
            function loadPage() {
                let accountId = $("#accountSelect").val();
                let fromDate = $("#fromDate").val();
                let toDate = $("#toDate").val();

                if (!accountId || !fromDate || !toDate) {
                    alert("Please select account and date range");
                    return;
                }

                $.getJSON(`/api/Account/${accountId}/${fromDate}/${toDate}?pageNumber=${currentPage}&pageSize=${pageSize}`, function (resp) {
                    tableData = resp.data || [];
                    let pagination = resp.pagination || {};
                    let tbody = $("#accountTable tbody");
                    tbody.empty();

                    $.each(tableData, function (i, row) {
                        tbody.append(`
                <tr>
                    <td>${row.accountID}</td>
                    <td>${row.accountName}</td>
                    <td>${row.previousBalance}</td>
                    <td>${row.debitAmount}</td>
                    <td>${row.creditAmount}</td>
                    <td>${row.finalBalance}</td>
                    <td><button class="btn btn-sm btn-info view-transaction" data-id="${row.balanceHisId}">View</button></td>
                </tr>
            `);
                    });

                    renderPagination(pagination);
                });
            }


            // Render pagination
            function renderPagination(p) {
                let ul = $("#pagination");
                ul.empty();

                if (!p.totalPages || p.totalPages <= 1) return;

                // Prev
                ul.append(`<li class="page-item ${p.pageNumber === 1 ? "disabled" : ""}">
                    <a class="page-link" href="#">Prev</a></li>`);

                // Pages
                for (let i = 1; i <= p.totalPages; i++) {
                    ul.append(`<li class="page-item ${i === p.pageNumber ? "active" : ""}">
                        <a class="page-link" href="#">${i}</a></li>`);
                }

                // Next
                ul.append(`<li class="page-item ${p.pageNumber === p.totalPages ? "disabled" : ""}">
                    <a class="page-link" href="#">Next</a></li>`);

                // Click events
                ul.find("a").click(function (e) {
                    e.preventDefault();
                    let text = $(this).text();
                    if (text === "Prev" && currentPage > 1) currentPage--;
                    else if (text === "Next" && currentPage < p.totalPages) currentPage++;
                    else if (!isNaN(text)) currentPage = parseInt(text);
                    loadPage();
                });
            }
            let totalDebit = 0;
            let totalCredit = 0;
            let totalFinal = 0;
            let firstPrevBalance = tableData.length > 0 ? tableData[0].previousBalance : 0;

            $.each(tableData, function (i, row) {
                totalDebit += row.debitAmount || 0;
                totalCredit += row.creditAmount || 0;
                totalFinal += row.finalBalance || 0;
            });

            // Update table footer
            $("#totalDebit").text(totalDebit);
            $("#totalCredit").text(totalCredit);
            $("#totalFinal").text(totalFinal);

            // Update summary section
            $("#firstPrevBalance").text(firstPrevBalance);
            $("#sumDebit").text(totalDebit);
            $("#sumCredit").text(totalCredit);
            $("#sumFinal").text(totalFinal);

            // View transaction details
            $(document).on("click", ".view-transaction", function () {
                let transactionId = $(this).data("id");
                $.getJSON(`/api/Account/${transactionId}`, function (details) {
                    let html = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
                    $("#transactionDetails").html(html);
                    let modal = new bootstrap.Modal(document.getElementById("transactionModal"));
                    modal.show();
                });
            });

            // Print
            $("#printBtn").click(function () {
                if (tableData.length === 0) {
                    alert("No data to print");
                    return;
                }
                let printWindow = window.open("", "", "width=800,height=600");
                let html = "<table border='1'><tr><th>ID</th><th>Name</th><th>Prev</th><th>Debit</th><th>Credit</th><th>Final</th></tr>";
                tableData.forEach(row => {
                    html += `<tr>
                        <td>${row.accountID}</td>
                        <td>${row.accountName}</td>
                        <td>${row.previousBalance}</td>
                        <td>${row.debitAmount}</td>
                        <td>${row.creditAmount}</td>
                        <td>${row.finalBalance}</td>
                    </tr>`;
                });
                html += "</table>";
                printWindow.document.write(html);
                printWindow.document.close();
                printWindow.print();
            });

            // Export to Excel
            $("#exportBtn").click(function () {
                if (!tableData || tableData.length === 0) {
                    alert("No data to export");
                    return;
                }
                let ws = XLSX.utils.json_to_sheet(tableData);
                let wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Account Statement");
                XLSX.writeFile(wb, "AccountStatement.xlsx");
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
