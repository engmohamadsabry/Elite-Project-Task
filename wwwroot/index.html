<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Statement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-4">

    <div class="container">
        <h2 class="mb-4">Account Statement</h2>

        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Select Account</label>
                <select id="accountSelect" class="form-select"></select>
            </div>
            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" id="fromDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" id="toDate" class="form-control">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button id="searchBtn" class="btn btn-primary w-100">Search</button>
            </div>
        </div>

        <!-- Actions -->
        <div class="mb-3">
            <button id="printBtn" class="btn btn-secondary me-2">Print</button>
            <button id="exportBtn" class="btn btn-success">Export to Excel</button>
        </div>

        <!-- Table -->
        <table class="table table-bordered" id="accountTable">
            <thead class="table-light">
                <tr>
                    <th>Account ID</th>
                    <th>Account Name</th>
                    <th>Previous Balance</th>
                    <th>Debit Amount</th>
                    <th>Credit Amount</th>
                    <th>Final Balance</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transaction Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionDetails"></div>
            </div>
        </div>
    </div>

    <script>
        let tableData = [];

        $(document).ready(function () {
            // Load accounts into dropdown
            $.getJSON("/api/Account", function (accounts) {
                $("#accountSelect").append(`<option value="">-- Select Account --</option>`);
                $.each(accounts, function (i, acc) {
                    $("#accountSelect").append(`<option value="${acc.accountId}">${acc.accountName}</option>`);
                });
            });

            // Search button
            $("#searchBtn").click(function () {
                let accountId = $("#accountSelect").val();
                let fromDate = $("#fromDate").val();
                let toDate = $("#toDate").val();

                if (!accountId || !fromDate || !toDate) {
                    alert("Please select account and date range");
                    return;
                }

                $.getJSON(`/api/Account/${accountId}/${fromDate}/${toDate}`, function (data) {
                    tableData = data; // save for Excel export
                    let tbody = $("#accountTable tbody");
                    tbody.empty();

                    $.each(data, function (i, row) {
                        tbody.append(`
                            <tr>
                                <td>${row.accountID}</td>
                                <td>${row.accountName}</td>
                                <td>${row.previousBalance}</td>
                                <td>${row.debitAmount}</td>
                                <td>${row.creditAmount}</td>
                                <td>${row.finalBalance}</td>
                                <td><button class="btn btn-sm btn-info view-transaction" data-id="${row.balanceHisId}">View</button></td>
                            </tr>
                        `);
                    });
                });
            });

            // View transaction details
            $(document).on("click", ".view-transaction", function () {
                let transactionId = $(this).data("id");

                $.getJSON(`/api/Account/${transactionId}`, function (details) {
                    let html = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
                    $("#transactionDetails").html(html);
                    let modal = new bootstrap.Modal(document.getElementById("transactionModal"));
                    modal.show();
                });
            });

            // Print
            $("#printBtn").click(function () {
                if (tableData.length === 0) {
                    alert("No data to print");
                    return;
                }

                let printWindow = window.open("", "", "width=800,height=600");
                let html = "<table border='1'><tr><th>ID</th><th>Name</th><th>Prev</th><th>Debit</th><th>Credit</th><th>Final</th></tr>";
                tableData.forEach(row => {
                    html += `<tr>
                        <td>${row.accountID}</td>
                        <td>${row.accountName}</td>
                        <td>${row.previousBalance}</td>
                        <td>${row.debitAmount}</td>
                        <td>${row.creditAmount}</td>
                        <td>${row.finalBalance}</td>
                    </tr>`;
                });
                html += "</table>";
                printWindow.document.write(html);
                printWindow.document.close();
                printWindow.print();
            });

            // Export to Excel
            // Export to Excel
            $("#exportBtn").click(function () {
                if (!tableData || tableData.length === 0) {
                    alert("No data to export");
                    return;
                }

                // Create workbook and worksheet
                let ws = XLSX.utils.json_to_sheet(tableData);
                let wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Account Statement");

                // Download
                XLSX.writeFile(wb, "AccountStatement.xlsx");
            });

        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
